#!/usr/bin/env bash
set -euo pipefail

# ---------- Colored logging functions ----------
info() { echo -e "\033[0;36m[i]\033[0m $*"; }
warn() { echo -e "\033[1;33m[!]\033[0m $*"; }
success() { echo -e "\033[0;32m[✔]\033[0m $*"; }
error() { echo -e "\033[0;31m[✘]\033[0m $*" >&2; }

# ---------- Show current OS ----------
info "Current OS: {{ .osid }}"

# ---------- Handle Debian-based systems ----------
{{- $osid := .osid | lower -}}
{{- if or (contains "ubuntu" $osid) (contains "debian" $osid) }}

info "Detected a Debian-based system."
warn "Installing required packages (sudo required)..."

if ! sudo apt update; then
  error "Failed to update package list."
  exit 1
fi

if ! sudo apt install -y zsh; then
  error "Failed to install zsh."
  exit 1
fi

success "zsh installed successfully."

{{- else }}
warn "Not a Debian-based system. Skipping apt installation."
{{- end }}

# ---------- Linux-specific behavior ----------
{{- if contains "linux" $osid }}

# Set tmux config source and destination
TMUX_SRC="$HOME/.local/.tmux_runtime/.tmux.conf"
TMUX_DEST="$HOME/.tmux.conf"

warn "Linking tmux runtime config..."
if [ -f "$TMUX_SRC" ]; then
  ln -sf "$TMUX_SRC" "$TMUX_DEST"
  success "Linked tmux config to $TMUX_DEST"
else
  warn "tmux config source not found: $TMUX_SRC"
fi

# Attempt to change default shell to zsh
if zsh_path="$(command -v zsh 2>/dev/null)"; then
  info "Changing default shell to: $zsh_path"
  if chsh -s "$zsh_path"; then
    success "Shell changed to zsh."
  else
    warn "chsh failed. You may need to run it manually or with sudo."
  fi
else
  warn "zsh not found in PATH. Skipping chsh."
fi

{{- end }}
